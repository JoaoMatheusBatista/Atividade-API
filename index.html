<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversão de Moedas - Global Exchange</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(230, 230, 230, 0.9)), url('https://source.unsplash.com/1600x900/?finance,marketing');
            background-size: cover;
            background-position: center;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar {
            background-color: #2E8B57;
        }
        .text {
            font-weight: bold;
            color: #fff;
            padding: 15px;
        }
        .navbar p {
            margin: 0;
            font-size: 1rem;
            color: #fff;
        }
        .header-display {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        .header-display p {
            font-size: 1.5rem;
            color: #2E8B57;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
            margin-bottom: auto;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #2E8B57;
            color: white;
            text-align: center;
            font-size: 1.5rem;
            padding: 15px;
            border-radius: 10px 10px 0 0;
        }
        .btn-primary {
            background-color: #2E8B57;
            border: none;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2E8B57;
        }
        .footer {
            background-color: #2E8B57;
            color: white;
            padding: 15px;
            text-align: center;
            width: 100%;
        }
        .input-label {
            font-weight: bold;
            color: #555;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <h2 class="text">Global Exchange</h2>
            <h5 class="text mb-0">Seu parceiro confiável em conversão de moedas</h5>
        </div>
    </nav>

    <div class="container my-5 flex-grow-1">
        <div class="header-display"></div>

        <div class="card p-4">
            <div class="card-header">
                <i class="fas fa-coins"></i> Conversão de Moedas
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="amount" class="form-label input-label">Quantia</label>
                    <input type="number" id="amount" class="form-control" placeholder="Digite a quantia" required>
                </div>

                <div class="mb-3">
                    <label for="fromCurrency" class="form-label input-label">De (Moeda)</label>
                    <select id="fromCurrency" class="form-select">
                        <option value="USD">USD - Dólar Americano</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="BRL">BRL - Real Brasileiro</option>
                        <option value="GBP">GBP - Libra Esterlina</option>
                        <option value="JPY">JPY - Iene Japonês</option>
                        <option value="AUD">AUD - Dólar Australiano</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="toCurrency" class="form-label input-label">Para (Moeda)</label>
                    <select id="toCurrency" class="form-select">
                        <option value="BRL">BRL - Real Brasileiro</option>
                        <option value="USD">USD - Dólar Americano</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - Libra Esterlina</option>
                        <option value="JPY">JPY - Iene Japonês</option>
                        <option value="AUD">AUD - Dólar Australiano</option>
                    </select>
                </div>

                <button id="convertBtn" class="btn btn-primary w-100">Converter</button>
                <h2 id="result" class="text-center mt-4"></h2>
            
                <button id="listCurrenciesBtn" class="btn btn-primary w-100">Listar Moedas Disponíveis (Base em Euro)</button>
                <div id="currencyList" class="row mt-3"></div>

                <button id="viewLogsBtn" class="btn btn-secondary w-100 mt-3">Ver Logs</button>
                <div id="logList" class="mt-3"></div>

            </div>
        </div>
    </div>

    <div class="footer">
        &copy 2024 Global Exchange - Todos os direitos reservados <br> Desenvolvido por João Matheus Batista - Fundamentos ao Desenvolvimento WEB
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiKey = '495d6c64b3bf29345e770b13c8bb5d73';
        const baseUrl = 'https://data.fixer.io/api/latest?access_key=' + apiKey;
        const MATRICULA = '427125';
        const logApiUrl = 'https://www.piway.com.br/unoesc/api/logs/' + MATRICULA;
        const fetchLogsUrl = 'https://www.piway.com.br/unoesc/api/logs/' + MATRICULA;
        const deleteLogUrl = 'https://www.piway.com.br/unoesc/api/excluir/log';

        async function getExchangeRates() {
            try {
                const response = await fetch(baseUrl);
                if (!response.ok) {
                    throw new Error('Erro ao buscar taxas de câmbio');
                }
                const data = await response.json();
                return data.rates;
            } catch (error) {
                console.error(error);
            }
        }

        async function logRequest(message) {
            try {
                const response = await fetch(logApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });
                if (!response.ok) {
                    throw new Error('Erro ao registrar log');
                }
            } catch (error) {
                console.error('Erro no registro de log:', error);
            }
        }

        async function convertCurrency(amount, fromCurrency, toCurrency) {
            const rates = await getExchangeRates();
            if (!rates || !rates[fromCurrency] || !rates[toCurrency]) {
                console.error('Moeda não encontrada.');
                return null;
            }

            const amountInBaseCurrency = amount / rates[fromCurrency];
            const convertedAmount = amountInBaseCurrency * rates[toCurrency];
            await logRequest(`Conversão: ${amount} ${fromCurrency} para ${convertedAmount.toFixed(2)} ${toCurrency}`);
            return convertedAmount;
        }

        document.getElementById('convertBtn').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const fromCurrency = document.getElementById('fromCurrency').value;
            const toCurrency = document.getElementById('toCurrency').value;

            if (isNaN(amount) || amount <= 0) {
                alert('Por favor, insira um valor válido.');
                return;
            }

            const result = await convertCurrency(amount, fromCurrency, toCurrency);
            if (result !== null) {
                document.getElementById('result').innerText = `${amount} ${fromCurrency} é igual a ${result.toFixed(2)} ${toCurrency}`;
            } else {
                document.getElementById('result').innerText = 'Erro na conversão.';
            }
        });

        async function listAvailableCurrencies() {
            const rates = await getExchangeRates();
            const currencyListElement = document.getElementById('currencyList');
            currencyListElement.innerHTML = ''; // Limpar conteúdo anterior

            if (!rates) {
                currencyListElement.innerHTML = '<div class="alert alert-danger">Não foi possível obter as taxas de câmbio.</div>';
                return;
            }

            await logRequest('Listagem de moedas disponíveis solicitada.');

            Object.keys(rates).forEach(currency => {
                const rateBlock = document.createElement('div');
                rateBlock.className = 'col-md-3 mb-3'; // Coluna de 3 colunas
                rateBlock.innerHTML = `
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">${currency}</h5>
                            <p class="card-text">Taxa: ${rates[currency]}</p>
                        </div>
                    </div>
                `;
                currencyListElement.appendChild(rateBlock);
            });
        }

        document.getElementById('listCurrenciesBtn').addEventListener('click', async () => {
            await listAvailableCurrencies();
        });

        async function viewLogs() {
            try {
                const response = await fetch(fetchLogsUrl);
                if (!response.ok) {
                    throw new Error('Erro ao buscar logs');
                }
                const logs = await response.json();
                const logListElement = document.getElementById('logList');
                logListElement.innerHTML = ''; // Limpar conteúdo anterior

                if (logs.length === 0) {
                    logListElement.innerHTML = '<div class="alert alert-info">Nenhum log encontrado.</div>';
                    return;
                }

                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'alert alert-secondary';
                    logItem.innerHTML = `
                        idLog: ${log.idlog} <br>Horário: ${log.log} <br>API: ${log.api} <br>Método: ${log.metodo} <br>Resultado: ${log.resultado}
                        <button class="btn btn-danger mt-2" onclick="deleteLog(${log.idlog})">Excluir</button>
                    `;
                    logListElement.appendChild(logItem);
                });
            } catch (error) {
                console.error('Erro ao visualizar logs:', error);
                document.getElementById('logList').innerHTML = '<div class="alert alert-danger">Erro ao buscar logs.</div>';
            }
        }

        async function deleteLog(idLog) {
            try {
                console.info(idLog);
                const response = await fetch(`${deleteLogUrl}/${idLog}/aluno/${MATRICULA}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Erro ao excluir o log');
                }

                const result = await response.json();
                if (result.message === "1 log foi excluído") {
                    alert("Log excluído com sucesso");
                    await viewLogs(); // Atualiza a lista de logs após exclusão
                } else {
                    alert("Nenhum log foi excluído");
                }
            } catch (error) {
                console.error('Erro ao excluir o log:', error);
                alert("Erro ao excluir o log");
            }
        }

        document.getElementById('viewLogsBtn').addEventListener('click', async () => {
            await viewLogs();
        });

    </script>
</body>
</html>
